<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="还没想好写什么">
    

    <!--Author-->
    
        <meta name="author" content="attax1994">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Attax1994">
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="还没想好写什么">
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Attax1994">

    <!--Type page-->
    
        <meta property="og:type" content="website">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>page - Attax1994</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="https://attax1994.github.io/Resume/">
                    About
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">Attax1994</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/04/26/2019/vue/Vue源码解析04--core.util-部分core模块通用函数/">
                Vue源码解析04--core.util-部分core模块通用函数
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-04-26</span>
            
            
            
                <span class="category">
                    <a href="/categories/前端开发/">前端开发</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="Core-Util主体结构"><a href="#Core-Util主体结构" class="headerlink" title="Core/Util主体结构"></a>Core/Util主体结构</h1><ul>
<li><strong>next-tick</strong>：<code>Vue.nextTick</code>的实现</li>
<li><strong>props</strong>：用于合法化prop，并加入observe</li>
<li><strong>options</strong>：Component构造函数中输入的options所需的相关处理</li>
<li><strong>lang</strong>：一些通用的检测与类型转换的封装</li>
<li><strong>error</strong>：针对<code>ViewModel</code>的错误信息的输出</li>
<li><strong>perm</strong>：Performance API的封装</li>
<li><strong>env</strong>：运行环境的检测</li>
<li><strong>debug</strong>：警告信息与错误栈的生成与输出，方便调试时排错</li>
</ul>
<h2 id="1-util-next-tick-js"><a href="#1-util-next-tick-js" class="headerlink" title="1. util/next-tick.js"></a>1. util/next-tick.js</h2><p><code>Vue.nextTick()</code>的实现，其优先级为：</p>
<ol>
<li><code>Promise</code>：micro</li>
<li><code>setImmediate</code>：macro</li>
<li><code>MessageChannel</code>：macro</li>
<li><code>setTimeout</code>：macro</li>
</ol>
<h3 id="建模"><a href="#建模" class="headerlink" title="建模"></a>建模</h3><p>对于<code>nextTick()</code>方法，它需要以下变量来建模：</p>
<ul>
<li>callbacks：回调队列，记录下一个tick要执行的所有回调</li>
<li>pending：指示是否正在运行上一个tick的回调</li>
<li>microTimerFunc：microtask的实现方式</li>
<li>macroTimerFunc：macrotask的实现方式</li>
<li>useMacroTask：指示是否使用macrotask</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调队列，记录下一个tick的所有回调</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">// 用于指示是否正在运行上一个tick的callbacks</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//依次执行所有的回调，复位pending，并清空callbacks队列</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallBacks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">  callbacks.length = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc</span><br><span class="line"><span class="comment">// 用于指示是否使用macroTimerFunc</span></span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="macroTimerFunc"><a href="#macroTimerFunc" class="headerlink" title="macroTimerFunc"></a>macroTimerFunc</h3><p>决定使用MacroTask来执行的方式，优先级为：setImmediate &gt; MessageChannel &gt; setTimeout</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 决定macroTimerFunc的实现。</span></span><br><span class="line"><span class="comment"> * 先用setImmediate（仅IE支持），没有就用MessageChannel，最后使用setTimeout</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 先尝试setImmediate</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> setImmediate !== <span class="string">'undefined'</span> &amp;&amp; isNative(setImmediate)) &#123;</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setImmediate(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 然后尝试MessageChannel</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span> &amp;&amp; (</span><br><span class="line">  isNative(MessageChannel) || </span><br><span class="line">  <span class="comment">// PhantomJS</span></span><br><span class="line">  MessageChannel.toString() === <span class="string">'[object MessageChannelConstructor]'</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = flushCallbacks</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最后尝试setTimeout</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="microTimerFunc"><a href="#microTimerFunc" class="headerlink" title="microTimerFunc"></a>microTimerFunc</h3><p>决定使用MicroTask执行的方式，首选Promise，不支持则转macroTimerFunc</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 决定microTimerFunc的实现。</span></span><br><span class="line"><span class="comment"> * 先用Promise，没有就直接套用MacroTimerFunc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 首先尝试Promise</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Promise</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  microTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    p.then(flushCallbacks)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ios下要通过触发一个新的MacroTask，使得MicroTask在此之前执行</span></span><br><span class="line">    <span class="keyword">if</span>(isIOS) setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;， <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="核心：Vue-nextTick-实现"><a href="#核心：Vue-nextTick-实现" class="headerlink" title="核心：Vue.nextTick()实现"></a>核心：Vue.nextTick()实现</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Vue.nextTick的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">cb?: <span class="built_in">Function</span>, ctx?: <span class="built_in">Object</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将回调以闭包形式加入堆栈，没有回调则以Promise的resolve作为回调</span></span><br><span class="line">  callbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(ctx)</span><br><span class="line">      &#125; catech(e) &#123;</span><br><span class="line">        handlerError(e, ctx, <span class="string">'nextTick'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(_resolve) &#123;</span><br><span class="line">      _resolve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 非pending情况下，开始运行</span></span><br><span class="line">  <span class="keyword">if</span>(!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 检查使用哪种task来触发</span></span><br><span class="line">    <span class="keyword">if</span>(useMacroTask) &#123;</span><br><span class="line">      macroTimerFunc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      microTimerFunc()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 回调为空，则尝试返回一个Promise来进行回调操作</span></span><br><span class="line">  <span class="keyword">if</span>(!cb &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他的helper函数"><a href="#其他的helper函数" class="headerlink" title="其他的helper函数"></a>其他的helper函数</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个闭包，使得该fn强制在MacroTask中执行</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withMacroTask</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn._withTask || (fn._withTask = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    useMacroTask = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> res = fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    useMacroTask = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-util-lang-js"><a href="#2-util-lang-js" class="headerlink" title="2. util/lang.js"></a>2. util/lang.js</h2><p>提供一些通用方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查某个字符串是否以$或_开头</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isReserved</span>(<span class="params">str: <span class="built_in">String</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> c = (str + <span class="string">''</span>).charCodeAt(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// 0x24为$，0x5F为_</span></span><br><span class="line">  <span class="keyword">return</span> c === <span class="number">0x24</span> || c ===<span class="number">0x5F</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.defineProperty的封装，其中enumerable默认为false</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">def</span>(<span class="params">obj: <span class="built_in">Object</span>, key: <span class="built_in">string</span>, val: <span class="built_in">any</span>, enumerable: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable,</span><br><span class="line">    writable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换路径，即在一个Object中逐层向内寻找，在watch中有使用</span></span><br><span class="line"><span class="keyword">const</span> bailRE = <span class="regexp">/[^\w.$]/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parsePath</span>(<span class="params">path: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(bailRE.test(path)) <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> segments = path.split(<span class="string">'.'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; segments.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(!obj) <span class="keyword">return</span> </span><br><span class="line">      obj = obj[segments[i]]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-util-error-js"><a href="#3-util-error-js" class="headerlink" title="3. util/error.js"></a>3. util/error.js</h2><p>针对<code>ViewModel</code>的错误处理器，会输出错误栈以便进行追踪</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制台输出错误</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logError</span>(<span class="params">err, vm, info</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(<span class="string">`Error in <span class="subst">$&#123;info&#125;</span>: "<span class="subst">$&#123;err.toString()&#125;</span>"`</span>, vm)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>((inBrowser || inWeex) &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">console</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> err</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局的ErrorHandler，从全局config中获取，并将其输出在控制台</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">globalHandleError</span>(<span class="params">err, vm, info</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(config.errorHandler) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> config.errorHandler.call(<span class="literal">null</span>, err, vm, info)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      logError(e, <span class="literal">null</span>, <span class="string">'config.errorHandler'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  logError(err, vm, info)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理错误，如果是vm中的错误，一层一层向上报出错误栈</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err: <span class="built_in">Error</span>, vm: <span class="built_in">any</span>, info: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(vm) &#123;</span><br><span class="line">    <span class="keyword">let</span> cur = vm</span><br><span class="line">    <span class="comment">// 组件从自身开始一层层向上报出错误</span></span><br><span class="line">    <span class="keyword">while</span>(cur = cur.$parent) &#123;</span><br><span class="line">      <span class="keyword">const</span> hooks = cur.$options.errorCaptured</span><br><span class="line">      <span class="keyword">if</span>(hooks) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; hooks.length; i++) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> capture = hooks[i].call(cur, err, vm, info) === <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span>(capture) <span class="keyword">return</span></span><br><span class="line">          &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            globalHandleError(e, cur, <span class="string">'errorCaptured hook'</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  globalHandleError(err, vm, info)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-util-perm-js"><a href="#4-util-perm-js" class="headerlink" title="4. util/perm.js"></a>4. util/perm.js</h2><p><code>Performance</code> API相关的操作，用来记录操作发生的时间戳和计算某些操作所用的时间。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> mark</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> measure</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> perf = inBrowser &amp;&amp; <span class="built_in">window</span>.performance</span><br><span class="line">  <span class="comment">// 检查浏览器是否支持Performance API</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    perf &amp;&amp;</span><br><span class="line">    perf.mark &amp;&amp;</span><br><span class="line">    perf.measure &amp;&amp;</span><br><span class="line">    perf.clearMarks &amp;&amp;</span><br><span class="line">    perf.clearMeasures</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 记录发生的时间戳</span></span><br><span class="line">    mark = <span class="function"><span class="params">tag</span> =&gt;</span> perf.mark(tag)</span><br><span class="line">    <span class="comment">// 计算两次记录的时间间隔，完成后消除相关记录和计算记录</span></span><br><span class="line">    measure = <span class="function">(<span class="params">name, startTag, endTag</span>) =&gt;</span> &#123;</span><br><span class="line">      perf.measure(name, startTag, endTag)</span><br><span class="line">      perf.clearMarks(startTag)</span><br><span class="line">      perf.clearMarks(endTag)</span><br><span class="line">      perf.clearMeasures(name)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-util-env-js"><a href="#5-util-env-js" class="headerlink" title="5. util/env.js"></a>5. util/env.js</h2><p><code>env</code>用于检测相关的系统环境。对于环境和设备类型的检测非常重要，可以根据其差异，来优化用户体验。</p>
<p>它包括了对以下环境变量和运行特性的检测：</p>
<ul>
<li><code>__proto__</code></li>
<li>运行环境：浏览器及其类型，Weex</li>
<li>被动的<code>eventListener</code>，即不能<code>preventDefault()</code></li>
<li>是否为SSR</li>
<li><code>Vue Devtools</code>插件</li>
<li>Symbol</li>
<li>Set</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否可以使用__proto__</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hasProto = <span class="string">'__proto__'</span> <span class="keyword">in</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浏览器环境检测</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> inBrowser = <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> inWeex = <span class="keyword">typeof</span> WXEnvironment !== <span class="string">'undefined'</span> &amp;&amp; !!WXEnvironment.platform</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> weexPlatform = inWeex &amp;&amp; WXEnvironment.platform.toLowerCase()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UA = inBrowser &amp;&amp; <span class="built_in">window</span>.navigator.userAgent.toLowerCase()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isIE = UA &amp;&amp; <span class="regexp">/msie|trident/</span>.test(UA)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isIE9 = UA &amp;&amp; UA.indexOf(<span class="string">'msie 9.0'</span>) &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isEdge = UA &amp;&amp; UA.indexOf(<span class="string">'edge/'</span>) &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isAndroid = (UA &amp;&amp; UA.indexOf(<span class="string">'android'</span>) &gt; <span class="number">0</span>) || (weexPlatform === <span class="string">'android'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isIOS = (UA &amp;&amp; <span class="regexp">/iphone|ipad|ipod|ios/</span>.test(UA)) || (weexPlatform === <span class="string">'ios'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isChrome = UA &amp;&amp; <span class="regexp">/chrome\/\d+/</span>.test(UA) &amp;&amp; !isEdge</span><br><span class="line"><span class="comment">// Firefox有独特的Object.prototype.watch()方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nativeWatch = (&#123;&#125;).watch</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否支持被动的eventListener，即preventDefault()没有效果</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> supportsPassive = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (inBrowser) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> opts = &#123;&#125;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(opts, <span class="string">'passive'</span>, (&#123;</span><br><span class="line">      <span class="keyword">get</span> () &#123;</span><br><span class="line">        supportsPassive = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;: <span class="built_in">Object</span>))</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'test-passive'</span>, <span class="literal">null</span>, opts)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否为Server Side Rendering，只能使用懒检查方式，因为SSR设置VUE_ENV晚于运行时</span></span><br><span class="line"><span class="keyword">let</span> _isServer</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isServerRendering = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (_isServer === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// 基本就是对Node.js环境的检测</span></span><br><span class="line">    <span class="keyword">if</span> (!inBrowser &amp;&amp; !inWeex &amp;&amp; <span class="keyword">typeof</span> global !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      _isServer = global[<span class="string">'process'</span>].env.VUE_ENV === <span class="string">'server'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _isServer = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _isServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测开发工具（Chrome的Vue Devtools插件）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> devtools = inBrowser &amp;&amp; <span class="built_in">window</span>.__VUE_DEVTOOLS_GLOBAL_HOOK__</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测某个class constructor是否原生支持</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isNative</span> (<span class="params">Ctor: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> Ctor === <span class="string">'function'</span> &amp;&amp; <span class="regexp">/native code/</span>.test(Ctor.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否支持ES6的Symbol</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hasSymbol =  <span class="keyword">typeof</span> Symbol !== <span class="string">'undefined'</span> &amp;&amp; isNative(Symbol) &amp;&amp;</span><br><span class="line">  <span class="keyword">typeof</span> Reflect !== <span class="string">'undefined'</span> &amp;&amp; isNative(Reflect.ownKeys)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set类型的检测，顺带简单的polyfill</span></span><br><span class="line"><span class="keyword">let</span> _Set</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> Set !== <span class="string">'undefined'</span> &amp;&amp; isNative(Set)) &#123;</span><br><span class="line">  _Set = Set</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  _Set = <span class="keyword">class</span> Set <span class="keyword">implements</span> SimpleSet &#123;</span><br><span class="line">    <span class="keyword">set</span>: <span class="built_in">Object</span>;</span><br><span class="line">    <span class="keyword">constructor</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.set = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    has (key: <span class="built_in">string</span> | <span class="built_in">number</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.set[key] === <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    add (key: <span class="built_in">string</span> | <span class="built_in">number</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.set[key] = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    clear () &#123;</span><br><span class="line">      <span class="keyword">this</span>.set = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-util-debug-js"><a href="#6-util-debug-js" class="headerlink" title="6. util/debug.js"></a>6. util/debug.js</h2><p> debug模式下的一些信息输出</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> warn</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> tip</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> generateComponentTrace</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> formatComponentName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">	<span class="keyword">const</span> hasConsole = <span class="keyword">typeof</span> <span class="built_in">console</span> !== <span class="string">'undefined'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 去除-和_，转为Pascal命名法</span></span><br><span class="line">  <span class="keyword">const</span> classifyRE = <span class="regexp">/(?:^|[-_])(\w)/g</span></span><br><span class="line">  <span class="keyword">const</span> classify = <span class="function"><span class="params">str</span> =&gt;</span> str</span><br><span class="line">    .replace(classifyRE, <span class="function"><span class="params">c</span> =&gt;</span> c.toUpperCase())</span><br><span class="line">    .replace(<span class="regexp">/[-_]/g</span>, <span class="string">''</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// warn()方法，输出警告</span></span><br><span class="line">  warn = <span class="function">(<span class="params">msg, vm</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// vm存在时，输出组件错误栈</span></span><br><span class="line">    <span class="keyword">const</span> trace = vm ? generateComponentTrace(vm) : <span class="string">''</span></span><br><span class="line">    <span class="comment">// 默认为console输出，除非特别指明了warnHandler</span></span><br><span class="line">    <span class="keyword">if</span> (config.warnHandler) &#123;</span><br><span class="line">      config.warnHandler.call(<span class="literal">null</span>, msg, vm, trace)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasConsole &amp;&amp; (!config.silent)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`[Vue warn]: <span class="subst">$&#123;msg&#125;</span><span class="subst">$&#123;trace&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// tip()方法，输出可行的优化方式</span></span><br><span class="line">  tip = <span class="function">(<span class="params">msg, vm</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasConsole &amp;&amp; (!config.silent)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`[Vue tip]: <span class="subst">$&#123;msg&#125;</span>`</span> + (vm ? generateComponentTrace(vm) : <span class="string">''</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 格式化组件的名称</span></span><br><span class="line">  <span class="comment">// name有三个来源：options.name，options._componentTag，文件名（去除.vue后缀）</span></span><br><span class="line">  formatComponentName = <span class="function">(<span class="params">vm, includeFile</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vm.$root === vm) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'&lt;Root&gt;'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 多渠道获取options</span></span><br><span class="line">    <span class="keyword">const</span> options = <span class="keyword">typeof</span> vm === <span class="string">'function'</span> &amp;&amp; vm.cid != <span class="literal">null</span></span><br><span class="line">      ? vm.options</span><br><span class="line">      : vm._isVue</span><br><span class="line">        ? vm.$options || vm.constructor.options</span><br><span class="line">        : vm || &#123;&#125;</span><br><span class="line">    <span class="keyword">let</span> name = options.name || options._componentTag</span><br><span class="line">    <span class="keyword">const</span> file = options.__file</span><br><span class="line">    <span class="keyword">if</span> (!name &amp;&amp; file) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = file.match(<span class="regexp">/([^/\\]+)\.vue$/</span>)</span><br><span class="line">      name = match &amp;&amp; match[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// 转为Pascal format</span></span><br><span class="line">      (name ? <span class="string">`&lt;<span class="subst">$&#123;classify(name)&#125;</span>&gt;`</span> : <span class="string">`&lt;Anonymous&gt;`</span>) +</span><br><span class="line">      (file &amp;&amp; includeFile !== <span class="literal">false</span> ? <span class="string">` at <span class="subst">$&#123;file&#125;</span>`</span> : <span class="string">''</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将一个字符串重复n遍，通过按位判断的方式，时间复杂度降为O(logn)</span></span><br><span class="line">  <span class="keyword">const</span> repeat = <span class="function">(<span class="params">str, n</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> (n) &#123;</span><br><span class="line">      <span class="keyword">if</span> (n % <span class="number">2</span> === <span class="number">1</span>) res += str</span><br><span class="line">      <span class="keyword">if</span> (n &gt; <span class="number">1</span>) str += str</span><br><span class="line">      n &gt;&gt;= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 生成组件栈，方便输出时追踪</span></span><br><span class="line">  generateComponentTrace = <span class="function"><span class="params">vm</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vm._isVue &amp;&amp; vm.$parent) &#123;</span><br><span class="line">      <span class="keyword">const</span> tree = []</span><br><span class="line">      <span class="keyword">let</span> currentRecursiveSequence = <span class="number">0</span></span><br><span class="line">      <span class="comment">// 向父级递归，将合法的vm压入队列</span></span><br><span class="line">      <span class="keyword">while</span> (vm) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tree.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> last = tree[tree.length - <span class="number">1</span>]</span><br><span class="line">          <span class="keyword">if</span> (last.constructor === vm.constructor) &#123;</span><br><span class="line">            currentRecursiveSequence++</span><br><span class="line">            vm = vm.$parent</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentRecursiveSequence &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            tree[tree.length - <span class="number">1</span>] = [last, currentRecursiveSequence]</span><br><span class="line">            currentRecursiveSequence = <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tree.push(vm)</span><br><span class="line">        vm = vm.$parent</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'\n\nfound in\n\n'</span> + tree</span><br><span class="line">        .map(<span class="function">(<span class="params">vm, i</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;i === 0 ? '---&gt; ' : repeat(' ', 5 + i * 2)&#125;</span></span></span><br><span class="line"><span class="string">          <span class="subst">$&#123;Array.isArray(vm) </span></span></span><br><span class="line"><span class="string"><span class="subst">             ? `$&#123;formatComponentName(vm[0])&#125;</span>... (<span class="subst">$&#123;vm[1]&#125;</span> recursive calls)`</span> </span><br><span class="line">             : formatComponentName(vm)</span><br><span class="line">          &#125;<span class="string">`,</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">        .join('\n')</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">      return `</span>\n\n(found <span class="keyword">in</span> $&#123;formatComponentName(vm)&#125;)<span class="string">`</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/04/26/2019/vue/Vue源码解析03--core/">
                Vue源码解析03--core
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-04-26</span>
            
            
            
                <span class="category">
                    <a href="/categories/前端开发/">前端开发</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h2 id="1-模块"><a href="#1-模块" class="headerlink" title="1. 模块"></a>1. 模块</h2><ul>
<li>util：通用的方法。</li>
<li>instance：Vue实例的定义与生成。</li>
<li>observer：观察者，对组件实例属性的响应式改造，从而实现响应式更新。</li>
<li>vdom：vnode的生成与更新机制。</li>
<li>global-api：一些全局使用的API</li>
<li>component：keep-alive</li>
</ul>
<h2 id="2-index-js"><a href="#2-index-js" class="headerlink" title="2. index.js"></a>2. index.js</h2><p>core的入口主要做这几件事：</p>
<ul>
<li>初始化全局API</li>
<li>定义Vue.prototype的<code>$isServer</code>、<code>$ssrContext</code>属性</li>
<li>定义Vue的<code>FunctionalRenderContext</code>属性</li>
<li><code>Vue.version = &#39;__VERSION__&#39;</code></li>
<li><code>export default Vue</code></li>
</ul>
<h2 id="3-config-js"><a href="#3-config-js" class="headerlink" title="3. config.js"></a>3. config.js</h2><p><code>core/config.js</code>用于定义Vue全局设置的类型和初始设置。</p>
<p>该初始设置绝大部分涉及到<code>shared</code>目录下的共享对象和函数。</p>
<p>在初始状态下绝大部分为空值或空函数，需要在运行时中，根据环境和具体设置来进行二次设定。</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/04/26/2019/vue/Vue源码解析02--shared/">
                Vue源码解析02--shared
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-04-26</span>
            
            
            
                <span class="category">
                    <a href="/categories/前端开发/">前端开发</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h2 id="1-constants-js-全局常量"><a href="#1-constants-js-全局常量" class="headerlink" title="1. constants.js 全局常量"></a>1. constants.js 全局常量</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SSR_ARRT = <span class="string">'data-server-rendered'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue中资源的三种类型名称</span></span><br><span class="line"><span class="keyword">const</span> ASSET_TYPES = &#123;</span><br><span class="line">  <span class="string">'component'</span>,</span><br><span class="line">  <span class="string">'directive'</span>,</span><br><span class="line">  <span class="string">'filter'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件生命周期钩子的名称</span></span><br><span class="line"><span class="keyword">const</span> LIFECYCLE_HOOKS = &#123;</span><br><span class="line">  <span class="string">'beforeCreate'</span>,</span><br><span class="line">  <span class="string">'created'</span>,</span><br><span class="line">  <span class="string">'beforeMount'</span>,</span><br><span class="line">  <span class="string">'mounted'</span>,</span><br><span class="line">  <span class="string">'beforeUpdate'</span>,</span><br><span class="line">  <span class="string">'updated'</span>,</span><br><span class="line">  <span class="string">'beforeDestroy'</span>,</span><br><span class="line">  <span class="string">'destroyed'</span>,</span><br><span class="line">  <span class="string">'activated'</span>,</span><br><span class="line">  <span class="string">'deactivated'</span>,</span><br><span class="line">  <span class="string">'errorCaptured'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-util-js-通用的函数"><a href="#2-util-js-通用的函数" class="headerlink" title="2. util.js 通用的函数"></a>2. util.js 通用的函数</h2><h3 id="2-1-类型判断的函数"><a href="#2-1-类型判断的函数" class="headerlink" title="2.1 类型判断的函数"></a>2.1 类型判断的函数</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空对象，不能做任何修改</span></span><br><span class="line"><span class="keyword">const</span> emptyObject = <span class="built_in">Object</span>.freeze(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否为undefined或null（也可以用双等号==）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUndef</span> (<span class="params">v: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123; <span class="keyword">return</span> v === <span class="literal">undefined</span> || v === <span class="literal">null</span> &#125;</span><br><span class="line"><span class="comment">// 与isUndef相反</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isDef</span>(<span class="params">v: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123; <span class="keyword">return</span> v !== <span class="literal">undefined</span> &amp;&amp; v !== <span class="literal">null</span> &#125;</span><br><span class="line"><span class="comment">// 判断是否为true，对应的还有 isFalse()</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isTrue</span>(<span class="params">v: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123; <span class="keyword">return</span> v === <span class="literal">true</span> &#125;</span><br><span class="line"><span class="comment">// 判断是否为非空的基本类型（number, string, symbol, boolean）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPrimitive</span>(<span class="params">v: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> v === <span class="string">'string'</span> ||</span><br><span class="line">          <span class="keyword">typeof</span> v === <span class="string">'number'</span> ||</span><br><span class="line">          <span class="keyword">typeof</span> v === <span class="string">'symbol'</span> ||</span><br><span class="line">          <span class="keyword">typeof</span> v === <span class="string">'boolean'</span></span><br><span class="line">	)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 判断是否为对象，注意先去除null的错误判断</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObject</span>(<span class="params">obj: mixed</span>): <span class="title">boolean</span> </span>&#123; <span class="keyword">return</span> obj !== <span class="literal">null</span> || <span class="keyword">typeof</span> obj === <span class="string">'object'</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.prototype.toString的alias</span></span><br><span class="line"><span class="keyword">const</span> _toString = <span class="built_in">Object</span>.prototype.toString</span><br><span class="line"><span class="comment">// 用Object.prototype.toString来调取类型，比typeof更准确，能判断null和内置对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toRawType</span>(<span class="params">v: <span class="built_in">any</span></span>): <span class="title">string</span> </span>&#123; <span class="keyword">return</span> _toString.call(v).slice(<span class="number">8</span>, <span class="number">-1</span>) &#125;</span><br><span class="line"><span class="comment">// 是否为纯对象，类似的还有isRegExp(), </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPlainObject</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123; <span class="keyword">return</span> _toString.call(obj)===<span class="string">'[object Object]'</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为有效的数组索引（自然数）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isValidArrayIndex</span>(<span class="params">val: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保留纯数字部分</span></span><br><span class="line">  <span class="keyword">const</span> n = <span class="built_in">parseFloat</span>(<span class="built_in">String</span>(val))</span><br><span class="line">  <span class="comment">// Array的index要为自然数</span></span><br><span class="line">  <span class="keyword">return</span> n &gt;= <span class="number">0</span> &amp;&amp; <span class="built_in">Math</span>.floor(n) === n &amp;&amp; <span class="built_in">isFinite</span>(val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-对象相关函数"><a href="#2-2-对象相关函数" class="headerlink" title="2.2 对象相关函数"></a>2.2 对象相关函数</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将任何类型转换为string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toString</span>(<span class="params">val: <span class="built_in">any</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> val == <span class="literal">null</span> ? </span><br><span class="line">    <span class="string">''</span> : <span class="keyword">typeof</span> val === <span class="string">'object'</span> ? <span class="built_in">JSON</span>.stringify(val, <span class="literal">null</span>, <span class="number">2</span>): <span class="built_in">String</span>(val)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将一个输入string转换为number；如果失败，返回原string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toNumber</span>(<span class="params">val: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> n = <span class="built_in">parseFloat</span>(val)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">isNaN</span>(n) ? val : n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个map的闭包，用于检查某个key是否为它的属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeMap</span>(<span class="params">str: <span class="built_in">string</span>, expectesLowerCase?: <span class="built_in">boolean</span></span>): (<span class="params">key: <span class="built_in">string</span></span>) =&gt; <span class="title">true</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> list: <span class="built_in">Array</span>&lt;<span class="built_in">string</span>&gt; = str.split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">    map[list[i]] = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> expectedLowerCase ? <span class="function"><span class="params">val</span> =&gt;</span> map[val.toLowerCase]: <span class="function"><span class="params">val</span> =&gt;</span> map[val] </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// makeMap生成的&#123;slot: true, component: true&#125;来检查元素的tag是否为Vue的内置tag</span></span><br><span class="line"><span class="keyword">const</span> isBuiltInTag = makeMap(<span class="string">'slot,component'</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="comment">// 检查元素某个属性是否为Vue的保留属性（key, ref, slot, slot-scope, is）</span></span><br><span class="line"><span class="keyword">const</span> isReservedAttribute = makeMap(<span class="string">'key,ref,slot,slot-scope,is'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从arr中移除item</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params">arr: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt;, item: <span class="built_in">any</span></span>): <span class="title">Array</span>&lt;<span class="title">any</span>&gt; | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(arr.lenght) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = arr.indexOf(item)</span><br><span class="line">    <span class="comment">// 可以使用(~index)替代</span></span><br><span class="line">    <span class="keyword">if</span>(index &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> arr.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.prototype.hasOwnProperty的alias</span></span><br><span class="line"><span class="keyword">const</span> hasOwnProperty = <span class="built_in">Object</span>.prototype.hasOwnProperty</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasOwn</span>(<span class="params">obj: <span class="built_in">Object</span> | <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt;, key: <span class="built_in">string</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> hasOwnProperty.call(obj, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-字符串转换函数"><a href="#2-3-字符串转换函数" class="headerlink" title="2.3 字符串转换函数"></a>2.3 字符串转换函数</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建某个纯函数的闭包，该闭包有一个结果缓存，对于运算量较大的函数，可以减少重复运算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cached</span>&lt;<span class="title">F</span>&gt;(<span class="params">fn: F</span>): <span class="title">F</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">cachedFn</span>(<span class="params">str: <span class="built_in">string</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hit = cache[str]</span><br><span class="line">    <span class="keyword">return</span> hit || (cache[str] = fn(str))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将烤肉串式命名转为驼峰式命名</span></span><br><span class="line"><span class="keyword">const</span> camelizeRE = <span class="regexp">/-(\w)/g</span></span><br><span class="line"><span class="keyword">const</span> camelize = cached((str: <span class="built_in">string</span>): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> str.replace(camelizeRE, <span class="function">(<span class="params">match, p1</span>) =&gt;</span> p1 ? p1.toUppercase() : <span class="string">''</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 将驼峰式命名转为烤肉串式命名</span></span><br><span class="line"><span class="keyword">const</span> hyphenRE = <span class="regexp">/\B([A-Z])/g</span></span><br><span class="line"><span class="keyword">const</span> hyphenate = cached((str: <span class="built_in">string</span>): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> str.replace(hyphenRE, <span class="string">'-$1'</span>).toLowerCase()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串首字母大写</span></span><br><span class="line"><span class="keyword">const</span> capitalize = cached((str: <span class="built_in">string</span>): <span class="function"><span class="params">stirng</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> str.charAt(<span class="number">0</span>).toUpperCase() + str.slice(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-Function相关函数"><a href="#2-4-Function相关函数" class="headerlink" title="2.4 Function相关函数"></a>2.4 Function相关函数</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bind的polyfill措施</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 适用于PhantomJS 1.x的兼容性bind</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">polyfillBind</span>(<span class="params">fn: <span class="built_in">Function</span>, ctx: <span class="built_in">Object</span></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">boundFn</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> len = <span class="built_in">arguments</span>.length</span><br><span class="line">    <span class="keyword">return</span> len</span><br><span class="line">      ? len &gt; <span class="number">1</span> ? fn.apply(ctx, <span class="built_in">arguments</span>) : fn.call(ctx, a)</span><br><span class="line">    	: fn.call(ctx)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  boundFn._length = fn.length</span><br><span class="line">  <span class="keyword">return</span> boundFn</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 原生的bind</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nativeBind</span>(<span class="params">fn: <span class="built_in">Function</span>, ctx: <span class="built_in">Object</span></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn.bind(ctx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> bind = <span class="built_in">Function</span>.prototype.bind ? nativeBind : polyfillBind</span><br><span class="line"></span><br><span class="line"><span class="comment">// Array-like转Array</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params">list: <span class="built_in">any</span>, start: <span class="built_in">number</span> = 0</span>): <span class="title">Array</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = list.length - start</span><br><span class="line">  <span class="keyword">const</span> ret: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt; = <span class="keyword">new</span> <span class="built_in">Array</span>(i)</span><br><span class="line">  <span class="keyword">while</span>(i--) &#123;</span><br><span class="line">    ret[i] = list[i + start]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将一个对象混入另一个对象（并不是严格的继承）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">to: Ojbect, <span class="keyword">from</span>: <span class="built_in">Object</span></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> key <span class="keyword">in</span> <span class="keyword">from</span>) <span class="keyword">if</span>(<span class="keyword">from</span>.hasOwnProperty(key)) to[key] = <span class="keyword">from</span>[key]</span><br><span class="line">  <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将一个Array&lt;Object&gt;转为Object</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toObject</span>(<span class="params">arr: <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt;</span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(arr[i]) extend(res, arr[i])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从某个compiler模块生成静态键</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genStaticKeys</span>(<span class="params">modules: <span class="built_in">Array</span>&lt;ModuleOptions&gt;</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> modules.reduce(<span class="function">(<span class="params">keys: <span class="built_in">Array</span>&lt;<span class="built_in">string</span>&gt;, m: ModuleOptions</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> keys.concat(m.staticKeys || [])</span><br><span class="line">  &#125;, []).join(<span class="string">','</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 广义相等检查，特别对于Object，只检查它们是否形式相同</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">looseEqual</span>(<span class="params">a: <span class="built_in">any</span>, b: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (a === b) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> isObjectA = isObject(a)</span><br><span class="line">  <span class="keyword">const</span> isObjectB = isObject(b)</span><br><span class="line">  <span class="comment">// 引用类型</span></span><br><span class="line">  <span class="keyword">if</span>(isObjectA &amp;&amp; isObjectB) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> isArrayA = <span class="built_in">Array</span>.isArray(a)</span><br><span class="line">      <span class="keyword">const</span> isArrayB = <span class="built_in">Array</span>.isArray(b)</span><br><span class="line">      <span class="comment">// 都是Array，检查每个对应元素是否相同</span></span><br><span class="line">      <span class="keyword">if</span>(isArrayA &amp;&amp; isArrayB) &#123;</span><br><span class="line">        <span class="keyword">return</span> a.length === b.length &amp;&amp; a.every(<span class="function">(<span class="params">value, index</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> looseEqual(value, b[index])</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 都不是Array，检查每个键值对是否相同</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(!isArrayA &amp;&amp; !isArrayB) &#123;</span><br><span class="line">        <span class="keyword">const</span> keysA = <span class="built_in">Object</span>.keys(a)</span><br><span class="line">        <span class="keyword">const</span> keysB = <span class="built_in">Object</span>.keys(b)</span><br><span class="line">        <span class="keyword">return</span> keysA.length === keysB.length &amp;&amp; keysA.every(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> looseEuqal(a[key], b[key])</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 类型不为同一种引用类型</span></span><br><span class="line">      <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非引用类型，转为string处理</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(!isObjectA &amp;&amp; !isObjectB) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(a) === <span class="built_in">String</span>(b)</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// 两者类型不同</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用广义相等检查来进行索引查找</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">looseIndexOf</span>(<span class="params">arr: <span class="built_in">Array</span>&lt;mixed&gt;, val: mixed</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(looseEqual(arr[i], val)) <span class="keyword">return</span> i</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保证某个函数只运行一次</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">once</span> = (<span class="params">fn: <span class="built_in">Function</span></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> called = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!called) &#123;</span><br><span class="line">      called = <span class="literal">true</span></span><br><span class="line">      fn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
        </section>
    </div>
</div>



    <div class="row">
        <div class="col-sm-12">
            <div class="wrap-pagination">
                <a class href="/page/7/">
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </a>
                <a class href="/page/9/">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>




</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/04/26/2019/redux/6.bindActionCreators/">Redux源码解析06--bindActionCr</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/26/2019/redux/5.combineReducers/">Redux源码解析05--combineReduc</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/26/2019/redux/4.applyMiddleware/">Redux源码解析04--applyMiddlew</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/26/2019/redux/3.compose/">Redux源码解析03--compose</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/源码分析/">源码分析</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/学习计划/">学习计划</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/tutorial/">tutorial</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/前端开发/">前端开发</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>